<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Minimal Calendar & To-Do for Kobo</title>
<style>
body,html {
  margin:0; padding:0; font-family:sans-serif; 
  background:#fafafa; color:#000; 
  display:flex; flex-direction:column; height:100vh; 
}
.container {
  flex:1; display:flex; flex-direction:column; 
  padding:10px; box-sizing:border-box; 
}
.header {
  display:flex; justify-content:space-between; align-items:center; 
  margin-bottom:10px;
}
.header button {
  padding:5px 10px; font-size:14px; cursor:pointer;
}
.date-info {
  font-size:18px; font-weight:bold;
}
.editor, .work-blocks {
  margin-top:10px; 
}
.editor, .work-blocks {
  background:#fff; padding:10px; border-radius:5px; box-sizing:border-box; 
  overflow:auto; max-height:calc(100vh - 180px);
}
.clickable {
  cursor:pointer;
}
.clickable.completed { text-decoration:line-through; color:gray; }
.need-to-do { font-weight:bold; color:#d00; }
.block-title { font-weight:bold; margin-bottom:5px; }
.work-block { margin-bottom:15px; }
.hidden { display:none; }

.login-container {
  display:flex; justify-content:center; align-items:center; flex:1;
  flex-direction:column;
}
.login-container button {
  padding:10px 20px; font-size:16px; cursor:pointer;
}
.confetti-canvas {
  position:fixed; top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;
}
</style>
</head>
<body>
<div class="container" id="app">
  <div class="header">
    <button id="prev-day-btn">&lt;</button>
    <div class="date-info">
      <span id="day-name"></span> <span id="date-num"></span> <span id="month-name"></span>
    </div>
    <button id="next-day-btn">&gt;</button>
  </div>

  <div id="login-section" class="login-container hidden">
    <p>Log ind for at se dine opgaver</p>
    <button id="loginButton">Log ind med Google</button>
  </div>

  <div id="content-section" class="hidden">
    <div class="editor" contenteditable="true" id="editor">
      <div id="daily-frog" class="clickable need-to-do" contenteditable="true">üê∏ Dagens Tudse</div>
    </div>

    <div class="work-blocks" id="work-blocks-container">
      <div class="work-block" data-block-index="1">
        <div class="block-title" contenteditable="true">Work Block 1</div>
        <div class="block-tasks" contenteditable="true"></div>
      </div>
      <div class="work-block" data-block-index="2">
        <div class="block-title" contenteditable="true">Work Block 2</div>
        <div class="block-tasks" contenteditable="true"></div>
      </div>
      <div class="work-block" data-block-index="3">
        <div class="block-title" contenteditable="true">Work Block 3</div>
        <div class="block-tasks" contenteditable="true"></div>
      </div>
    </div>
  </div>
</div>
<canvas class="confetti-canvas hidden" id="confetti"></canvas>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
<script>
// Firebase config (same as provided)
const firebaseConfig = {
  apiKey: "AIzaSyAoY_XxClJRTUS6OJmaIDvZm014Lx7sXA4",
  authDomain: "copypaste2000-5776c.firebaseapp.com",
  databaseURL: "https://copypaste2000-5776c-default-rtdb.firebaseio.com",
  projectId: "copypaste2000-5776c",
  storageBucket: "copypaste2000-5776c.appspot.com",
  messagingSenderId: "733249598043",
  appId: "1:733249598043:web:6648bfe9b408127aa6457e",
  measurementId: "G-M16KES53R6"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

const loginSection = document.getElementById('login-section');
const contentSection = document.getElementById('content-section');
const loginButton = document.getElementById('loginButton');
const editor = document.getElementById('editor');
const prevDayBtn = document.getElementById('prev-day-btn');
const nextDayBtn = document.getElementById('next-day-btn');
const dayNameEl = document.getElementById('day-name');
const dateNumEl = document.getElementById('date-num');
const monthNameEl = document.getElementById('month-name');
const dailyFrog = document.getElementById('daily-frog');
const workBlocksContainer = document.getElementById('work-blocks-container');
const confettiCanvas = document.getElementById('confetti');

let userId = null;

const danishDays = ['S√∏ndag','Mandag','Tirsdag','Onsdag','Torsdag','Fredag','L√∏rdag'];
const danishMonths = ['Januar','Februar','Marts','April','Maj','Juni','Juli','August','September','Oktober','November','December'];

const startDateCalendar = 3;
const startMonthCalendar = 9; // October = 9
const endMonthCalendar = 11;  // December
const yearCalendar = 2024;
const canvasKeys = [];
let totalDays = 0;
for (let m = startMonthCalendar; m <= endMonthCalendar; m++) {
  const dim = new Date(yearCalendar, m+1,0).getDate();
  const sd = m===startMonthCalendar? startDateCalendar : 1;
  for (let d=sd; d<=dim; d++) {
    canvasKeys.push(`canvas${yearCalendar}${(m+1).toString().padStart(2,'0')}${d.toString().padStart(2,'0')}`);
    totalDays++;
  }
}

let currentIndex = 0;

function setCurrentIndexByDate() {
  const today = new Date();
  const start = new Date(yearCalendar, startMonthCalendar, startDateCalendar);
  if (today >= start && today <= new Date(yearCalendar, endMonthCalendar+1, 0)) {
    const daysSinceStart = Math.floor((today - start)/(1000*60*60*24));
    currentIndex = Math.min(daysSinceStart, totalDays-1);
  } else {
    currentIndex = 0;
  }
}

function updateDateDisplay() {
  let cDay = startDateCalendar;
  let cMonth = startMonthCalendar;
  for (let i=0;i<currentIndex;i++) {
    cDay++;
    if (cDay > new Date(yearCalendar,cMonth+1,0).getDate()) {
      cDay=1; cMonth++;
    }
  }
  const date = new Date(yearCalendar,cMonth,cDay);
  dayNameEl.textContent = danishDays[date.getDay()];
  dateNumEl.textContent = cDay;
  monthNameEl.textContent = danishMonths[cMonth];
}

function loadData() {
  if(!userId) return;
  const dateKey = canvasKeys[currentIndex];
  const toDoRef = db.ref(`users/${userId}/toDoList/${dateKey}`);
  const workBlocksRef = db.ref(`users/${userId}/workBlocks/${dateKey}`);
  const frogRef = db.ref(`users/${userId}/frog/${dateKey}`);

  toDoRef.once('value', s => {
    if(s.val()) editor.innerHTML = s.val();
    else {
      editor.innerHTML = '';
      // Re-insert daily frog at top if not present
      editor.insertAdjacentHTML('afterbegin', '<div id="daily-frog" class="clickable need-to-do" contenteditable="true">üê∏ Dagens Tudse</div>');
    }
    attachTaskListeners(editor);
  });

  frogRef.once('value', s=>{
    if(!s.val()) dailyFrog.innerHTML="üê∏ Dagens Tudse";
  });

  workBlocksRef.once('value', s => {
    const data = s.val();
    const blocks = workBlocksContainer.querySelectorAll('.work-block');
    blocks.forEach(b=>{
      const idx = b.getAttribute('data-block-index');
      const title = b.querySelector('.block-title');
      const tasks = b.querySelector('.block-tasks');
      if(data) {
        title.innerText = data[`title${idx}`]||`Work Block ${idx}`;
        tasks.innerHTML = data[`block${idx}`]||'';
      } else {
        title.innerText = `Work Block ${idx}`;
        tasks.innerHTML = '';
      }
      attachTaskListeners(tasks);
      checkBlockCompletion(b);
    });
  });
}

function saveData() {
  if(!userId) return;
  const dateKey = canvasKeys[currentIndex];
  const toDoRef = db.ref(`users/${userId}/toDoList/${dateKey}`);
  const workBlocksRef = db.ref(`users/${userId}/workBlocks/${dateKey}`);
  const frogRef = db.ref(`users/${userId}/frog/${dateKey}`);

  toDoRef.set(editor.innerHTML);
  const blocks = workBlocksContainer.querySelectorAll('.work-block');
  const data = {};
  blocks.forEach(b=>{
    const idx = b.getAttribute('data-block-index');
    const title = b.querySelector('.block-title').innerText;
    const tasks = b.querySelector('.block-tasks').innerHTML;
    data[`block${idx}`] = tasks;
    data[`title${idx}`] = title;
  });
  workBlocksRef.set(data);
  frogRef.set(dailyFrog.innerHTML);
}

function previousDay() {
  saveData();
  currentIndex = currentIndex === 0 ? canvasKeys.length-1 : currentIndex-1;
  updateDateDisplay();
  loadData();
}

function nextDay() {
  saveData();
  currentIndex = currentIndex === canvasKeys.length-1 ? 0 : currentIndex+1;
  updateDateDisplay();
  loadData();
}

function attachTaskListeners(element) {
  element.addEventListener('click', e=>{
    if(e.target.classList.contains('clickable')) {
      if(e.target.classList.contains('completed')) {
        e.target.classList.remove('completed');
      } else {
        e.target.classList.add('completed');
        if(e.target.id === 'daily-frog') {
          showConfetti();
        }
        checkAllTasksCompleted();
      }
      saveData();
    }
  });
}

function checkAllTasksCompleted() {
  // Could implement logic if all tasks are done, but keep it minimal
}

function checkBlockCompletion(block) {
  const tasks = block.querySelectorAll('.clickable');
  const done = block.querySelectorAll('.clickable.completed');
  const title = block.querySelector('.block-title');
  if(tasks.length>0 && tasks.length===done.length) {
    title.classList.add('completed');
  } else {
    title.classList.remove('completed');
  }
}

function showConfetti() {
  const canvas = confettiCanvas;
  canvas.classList.remove('hidden');
  const ctx = canvas.getContext('2d');
  const w = window.innerWidth;
  const h = window.innerHeight;
  canvas.width = w; canvas.height = h;
  let particles = [];
  for(let i=0;i<100;i++){
    particles.push({
      x:Math.random()*w,y:Math.random()*h,
      r:Math.random()*4+2,
      color:'hsl('+(Math.random()*360)+',100%,50%)',
      vy:Math.random()*2+1
    });
  }
  function drawConfetti() {
    ctx.clearRect(0,0,w,h);
    particles.forEach(p=>{
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,2*Math.PI);
      ctx.fillStyle=p.color;
      ctx.fill();
      p.y+=p.vy;
      if(p.y>h) p.y=-10;
    });
    requestAnimationFrame(drawConfetti);
  }
  drawConfetti();
  setTimeout(()=>{canvas.classList.add('hidden');},4000);
}

// Auth
auth.onAuthStateChanged(user=>{
  if(user) {
    userId = user.uid;
    loginSection.classList.add('hidden');
    contentSection.classList.remove('hidden');
    setCurrentIndexByDate();
    updateDateDisplay();
    loadData();
    setInterval(saveData,60000);
  } else {
    loginSection.classList.remove('hidden');
    contentSection.classList.add('hidden');
  }
});

loginButton.addEventListener('click',()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  // Use signInWithRedirect for Kobo compatibility
  auth.signInWithRedirect(provider);
});

prevDayBtn.addEventListener('click', previousDay);
nextDayBtn.addEventListener('click', nextDay);

document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') previousDay();
  if(e.key==='ArrowRight') nextDay();
});
window.addEventListener('beforeunload',saveData);
</script>
</body>
</html>
